<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Regex Study – Review</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .5rem 1rem;
    }
    .word-text { font-weight: 500; }
    .card + .card { margin-top: 1rem; }
  </style>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-3">Review Your Classifications</h1>
    {% if reason_message %}
    <p class="reason-msg fw-semibold mb-3 fs-5">{{ reason_message | safe }}</p>
    {% endif %}
    <p class="text-muted mb-4 fs-5">Please check your work—re-classify any word to the correct column before continuing.</p>

    <!-- Natural-language description -->
    <div class="mb-4">
      <h3><label class="form-label fw-semibold">Pattern Description:</label></h3>
      <textarea class="form-control fs-5" rows="3" readonly>{{ text_description }}</textarea>
    </div>

    <div class="row g-4">

    {# ---- three columns ---------------------------------------------------- #}
    {% for category, words in {
            "accepted":  accepted_words,
            "rejected":  rejected_words,
            "unsure":  unsure_words
         }.items() %}
      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-header text-bg-light">
            <h5 class="mb-0">{{ category|capitalize }}</h5>
          </div>

          <ul class="list-group list-group-flush" id="{{ category }}-list">
          {% for word in words %}
            <li class="list-group-item word-item">
              <span class="word-text">{{ word }}</span>

              <select class="form-select form-select-sm w-auto reclassify-dropdown"
                      data-word="{{ word }}">
                <option value="accept" {% if category == "accepted" %}selected{% endif %}>Accept</option>
                <option value="reject" {% if category == "rejected" %}selected{% endif %}>Reject</option>
                <option value="unsure" {% if category == "unsure" %}selected{% endif %}>Unsure</option>
              </select>
            </li>
          {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
    </div>

    <div class="mt-5 text-center">
      <button id="approveBtn" class="btn btn-primary btn-lg">
        Approve and Continue
      </button>
    </div>
  </div>

  <script>
    /* ──────────────────────────────────────────────────────────────────────────
       0.  One-time data from Flask
       ────────────────────────────────────────────────────────────────────────── */
    const SESSION_ID = {{ session_id|int }};

    /* ──────────────────────────────────────────────────────────────────────────
       1.  Quick references & helpers
       ────────────────────────────────────────────────────────────────────────── */
    const approveBtn  = document.getElementById('approveBtn');
    const selects     = Array.from(document.querySelectorAll('.reclassify-dropdown'));

    const lists = {
      accept : document.getElementById('accepted-list'),
      reject : document.getElementById('rejected-list'),
      unsure : document.getElementById('unsure-list')
    };

    function sanitizeWordForDisplay(word) {
      // Replace all control characters (U+0000–U+001F) with " ".
      return word.replace(/[\x00-\x1F]/g, ' ');
    }

    // Sanitize all visible word displays without altering what's submitted
    document.querySelectorAll('.word-text').forEach(span => {
      const raw = span.textContent;
      span.textContent = sanitizeWordForDisplay(raw);
    });

    // On load, resize the pattern description text box.
    document.addEventListener("DOMContentLoaded", () => {
        const descBox = document.querySelector("textarea.form-control");
        if (descBox) {
        // Set height to auto first to get accurate scrollHeight
        descBox.style.height = "auto";
        // Then set height to fit content
        descBox.style.height = descBox.scrollHeight + "px";
        }
    });


    function lockUI(on = true) {
      approveBtn.disabled = on;
      selects.forEach(sel => sel.disabled = on);
    }

    async function safeJson (response) {
      try {
        const t = await response.clone().text();
        return t.trim() ? JSON.parse(t) : null;
      } catch { return null; }
    }

    function followRedirect(response, fallback = '/study') {
      /* 1) HTTP 3xx (fetch redirect:'manual') */
      if (response.type === 'opaqueredirect' ||
          (response.status >= 300 && response.status < 400)) {
        window.location.href = fallback;
        return true;
      }
      return false;
    }

    /* ──────────────────────────────────────────────────────────────────────────
      2.  Live re-classification  (immediate submit, no redirect expected)
      ────────────────────────────────────────────────────────────────────────── */
      selects.forEach(select => {
      select.addEventListener('change', async () => {
        /* current   → new label */
        const prevLabel = Array.from(select.options)
        .find(o => o.defaultSelected).value;

        const newLabel  = select.value;
        const li        = select.closest('li');
        const word      = select.dataset.word;

        lockUI(true);                       // block everything

        try {
          const res = await fetch('/reclassify', {
            method : 'POST',
            headers: { 'Content-Type':'application/json' },
            body   : JSON.stringify({
                      session_id         : SESSION_ID,
                      word,
                      new_classification : newLabel,
                      classification_type: 'review'
                    })
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          /* ----- success → move the item to its new column ------------------- */
          lists[newLabel].appendChild(li);

          /* make this choice sticky (used as “previous” next time) */
          Array.from(select.options).forEach(o => {
            o.defaultSelected = (o.value === newLabel);
          });

        } catch (err) {
          console.warn('Failed to re-classify – the page will reload.\n' + err.message);
          /* visual rollback */
          select.value = prevLabel;
          location.reload();
        } finally {
          lockUI(false);                    // restore interactivity
        }
      });
    });

    /* ──────────────────────────────────────────────────────────────────────────
       3.  Approve & Continue
       ────────────────────────────────────────────────────────────────────────── */
      approveBtn.addEventListener('click', async () => {
        if (approveBtn.disabled) return;

        lockUI(true);
        approveBtn.textContent = 'Please wait…';

        try {
          const res = await fetch('/review', { method:'POST' });

          if (res.redirected) {
            window.location.href = res.url;
            return;
          }

          /* JSON {redirect:"/..."} fall-back (shouldn’t happen any more) */
          const data = await safeJson(res);
          if (data?.redirect) {
            window.location.href = data.redirect;
            return;
          }

          /* worst-case fall-back */
          window.location.href = '/study';

        } catch (err) {
          console.warn('Unable to continue:\n' + err.message);
          approveBtn.textContent = 'Approve and Continue';
          lockUI(false);
        }
      });
    </script>
</body>
</html>
